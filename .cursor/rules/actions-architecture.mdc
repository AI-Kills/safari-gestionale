# Actions Architecture - Server Actions con Prisma e Zod

## ğŸ“ Struttura Directory Actions

```
app/lib/actions/
â”œâ”€â”€ actions.ts                    # Entry point per backward compatibility
â”œâ”€â”€ index.ts                      # Re-export di tutte le funzioni
â”œâ”€â”€ entity-zod-schemas.ts         # Tutti gli schemi Zod per validazione
â”œâ”€â”€ api-layer.ts                  # Servizi CRUD generici
â”œâ”€â”€ data-transformers.ts          # Trasformatori per UI InputGroups
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ types.ts                  # Tipi TypeScript condivisi
â”‚   â”œâ”€â”€ helpers.ts                # Utility functions (Prisma, validazione)
â”‚   â””â”€â”€ general-utils.ts          # Utility generali per entitÃ 
â”œâ”€â”€ auth/
â”‚   â””â”€â”€ auth-actions.ts           # Autenticazione e gestione utenti
â”œâ”€â”€ clienti/
â”‚   â””â”€â”€ clienti-actions.ts        # CRUD clienti
â”œâ”€â”€ preventivi/
â”‚   â”œâ”€â”€ preventivi-actions.ts     # CRUD preventivi principali
â”‚   â””â”€â”€ preventivi-al-cliente-actions.ts # Gestione preventivi per cliente
â”œâ”€â”€ fornitori/
â”‚   â””â”€â”€ fornitori-actions.ts      # CRUD fornitori
â”œâ”€â”€ destinazioni/
â”‚   â””â”€â”€ destinazioni-actions.ts   # CRUD destinazioni
â”œâ”€â”€ servizi-a-terra/
â”‚   â””â”€â”€ servizi-a-terra-actions.ts # CRUD servizi a terra
â”œâ”€â”€ voli/
â”‚   â””â”€â”€ voli-actions.ts           # CRUD voli
â””â”€â”€ assicurazioni/
    â””â”€â”€ assicurazioni-actions.ts  # CRUD assicurazioni
```

## ğŸ”§ Principi Architetturali

### 1. **Separazione per EntitÃ **
- Ogni entitÃ  del database ha la sua directory dedicata
- Un file actions per entitÃ  con tutte le operazioni CRUD
- Nomi consistenti: `[entitÃ ]-actions.ts`

### 2. **Triplo Layer di Sicurezza**
```typescript
// 1. Validazione Zod
const validatedData = createClienteSchema.safeParse(parsedData);
// 2. Prisma Type Safety
const cliente = await prisma.cliente.create({ data: validatedData.data });
// 3. Error Handling
catch (error) { return handlePrismaError(error); }
```

### 3. **Server Actions Only**
```typescript
"use server"; // Sempre all'inizio di ogni file actions
```

## ğŸ“‹ Pattern Standard per Actions

### **Template Base per Nuove EntitÃ **

```typescript
"use server";

import { revalidatePath } from 'next/cache';
import type { [EntitÃ ] as [EntitÃ ]Type } from '../../definitions';
import { prisma, handleValidationErrors, handlePrismaError, parseFormDates } from '../utils/helpers';
import type { ApiResponse, DBResult } from '../utils/types';
import { [entitÃ ]Schema, create[EntitÃ ]Schema, update[EntitÃ ]Schema } from '../entity-zod-schemas';

// CREATE
export async function create[EntitÃ ](data: any): Promise<ApiResponse<[EntitÃ ]Type>> {
  try {
    const parsedData = parseFormDates(data);
    const validatedData = create[EntitÃ ]Schema.safeParse(parsedData);
    if (!validatedData.success) {
      return handleValidationErrors(validatedData.error);
    }

    const [entitÃ ] = await prisma.[entitÃ ].create({
      data: validatedData.data
    });

    revalidatePath('/dashboard/[entitÃ ]-table');
    return { success: true, data: [entitÃ ] as [EntitÃ ]Type };
  } catch (error) {
    return handlePrismaError(error);
  }
}

// READ ALL
export async function getAll[EntitÃ ](): Promise<[EntitÃ ]Type[]> {
  try {
    const [entitÃ ] = await prisma.[entitÃ ].findMany({
      orderBy: { nome: 'asc' } // o altro campo appropriato
    });
    return [entitÃ ] as [EntitÃ ]Type[];
  } catch (error) {
    console.error('Error fetching [entitÃ ]:', error);
    return [];
  }
}

// READ BY ID
export async function get[EntitÃ ]ById(id: string): Promise<DBResult<[EntitÃ ]Type>> {
  try {
    const [entitÃ ] = await prisma.[entitÃ ].findUnique({
      where: { id },
      include: { /* relazioni se necessarie */ }
    });
    
    if (![entitÃ ]) {
      return { success: false, errorsMessage: '[EntitÃ ] non trovata' };
    }
    
    return { success: true, data: [entitÃ ] as [EntitÃ ]Type };
  } catch (error) {
    console.error('Error fetching [entitÃ ] by id:', error);
    return { success: false, errorsMessage: 'Errore nel recupero [entitÃ ]' };
  }
}

// UPDATE
export async function update[EntitÃ ](data: any): Promise<ApiResponse<[EntitÃ ]Type>> {
  try {
    const parsedData = parseFormDates(data);
    const validatedData = update[EntitÃ ]Schema.safeParse(parsedData);
    if (!validatedData.success) {
      return handleValidationErrors(validatedData.error);
    }

    const [entitÃ ] = await prisma.[entitÃ ].update({
      where: { id: validatedData.data.id },
      data: validatedData.data
    });

    revalidatePath('/dashboard/[entitÃ ]-table');
    return { success: true, data: [entitÃ ] as [EntitÃ ]Type };
  } catch (error) {
    return handlePrismaError(error);
  }
}

// DELETE
export async function delete[EntitÃ ](id: string): Promise<ApiResponse> {
  try {
    await prisma.[entitÃ ].delete({
      where: { id }
    });

    revalidatePath('/dashboard/[entitÃ ]-table');
    return { success: true };
  } catch (error) {
    return handlePrismaError(error);
  }
}
```

## ğŸ”’ Integrazione con Zod

### **Schema Patterns**
```typescript
// entity-zod-schemas.ts

// Schema base completo
export const [entitÃ ]Schema = z.object({
  id: z.string().min(1, { message: "L'ID Ã¨ obbligatorio" }),
  nome: z.string().min(1, { message: "Il nome Ã¨ obbligatorio" })
    .max(255, { message: "Nome troppo lungo" }),
  // ... altri campi
});

// Schema per creazione (senza ID)
export const create[EntitÃ ]Schema = [entitÃ ]Schema.omit({ id: true });

// Schema per aggiornamento (tutti i campi opzionali tranne ID)
export const update[EntitÃ ]Schema = [entitÃ ]Schema.partial().extend({
  id: z.string().min(1, { message: "L'ID Ã¨ obbligatorio" })
});
```

### **Validazione Date**
```typescript
// Per campi date
data_di_nascita: z.date({ message: "Data di nascita non valida" }).optional().nullable(),

// Parsing automatico delle date
const parsedData = parseFormDates(data); // converte stringhe in Date objects
```

## ğŸ—„ï¸ Integrazione con Prisma

### **Client Prisma Singleton**
```typescript
// utils/helpers.ts
const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma = globalForPrisma.prisma ?? new PrismaClient();
```

### **Error Handling Prisma**
```typescript
// Gestione errori Prisma standardizzata
export function handlePrismaError(error: any): ApiResponse {
  if (error.code === 'P2002') {
    return { success: false, error: 'Un record con questi dati esiste giÃ ' };
  }
  if (error.code === 'P2025') {
    return { success: false, error: 'Record non trovato' };
  }
  return { success: false, error: error.message || 'Errore del database' };
}
```

### **Transazioni per Operazioni Complesse**
```typescript
// Esempio: creazione preventivo con servizi correlati
const result = await prisma.$transaction(async (tx) => {
  const preventivo = await tx.preventivo.create({ data: preventivoData });
  
  for (const servizio of servizi) {
    await tx.serviziATerra.create({
      data: { ...servizio, id_preventivo: preventivo.id }
    });
  }
  
  return preventivo;
});
```

## ğŸ“¤ Tipi di Risposta Standardizzati

### **ApiResponse per Operazioni CRUD**
```typescript
type ApiResponse<T = any> = {
  success: boolean
  data?: T
  error?: string
  errors?: Record<string, string[]> // Per errori di validazione Zod
}
```

### **DBResult per Query Complesse**
```typescript
type DBResult<T = any> = {
  success: boolean
  values?: T
  errorsMessage?: string
}
```

## ğŸ”„ Cache Revalidation

### **Paths Standard da Revalidare**
```typescript
// Per ogni entitÃ , revalida sempre:
revalidatePath('/dashboard/[entitÃ ]-table');

// Per operazioni che impattano dashboard generale:
revalidatePath('/dashboard');
revalidatePath('/dashboard/general-interface');
```

## ğŸ“Š Data Transformers

### **Per UI InputGroups**
```typescript
// data-transformers.ts
export class DataTransformers {
  static async [entitÃ ]ToInputGroup([entitÃ ]: any[]): Promise<[EntitÃ ]InputGroup[]> {
    // Trasforma dati DB in formato per UI components
  }
}
```

## ğŸš¨ Convenzioni Obbligatorie

### **1. Naming**
- File: `[entitÃ ]-actions.ts` (kebab-case)
- Funzioni: `create[EntitÃ ]`, `getAll[EntitÃ ]`, `update[EntitÃ ]`, `delete[EntitÃ ]`
- Schemi Zod: `[entitÃ ]Schema`, `create[EntitÃ ]Schema`, `update[EntitÃ ]Schema`

### **2. Import Order**
```typescript
"use server";

import { revalidatePath } from 'next/cache';
import type { [EntitÃ ] as [EntitÃ ]Type } from '../../definitions';
import { prisma, handleValidationErrors, handlePrismaError, parseFormDates } from '../utils/helpers';
import type { ApiResponse, DBResult } from '../utils/types';
import { [schemas] } from '../entity-zod-schemas';
```

### **3. Export da index.ts**
```typescript
// Sempre aggiungere nuove actions a index.ts
export * from './[entitÃ ]/[entitÃ ]-actions';
```

### **4. Sincronizzazione Obbligatoria**
Quando aggiungi una nuova entitÃ , devi sempre aggiornare:
1. `prisma/schema.prisma` - Schema database
2. `app/lib/definitions.ts` - Tipi TypeScript
3. `app/lib/actions/entity-zod-schemas.ts` - Schemi validazione
4. `app/lib/actions/[entitÃ ]/[entitÃ ]-actions.ts` - Server actions
5. `test/actions.test.ts` - Test per le nuove actions

## ğŸ§ª Testing delle Actions

Ogni action deve avere test corrispondenti in `test/actions.test.ts`:

```typescript
describe('[EntitÃ ] Actions', () => {
  test('should create [entitÃ ] successfully', async () => {
    // Test creazione valida
  });
  
  test('should reject invalid data', async () => {
    // Test validazione Zod
  });
  
  test('should handle database errors', async () => {
    // Test gestione errori Prisma
  });
});
```

## ğŸ’¡ Best Practices

1. **Sempre validare con Zod prima di Prisma**
2. **Usare transazioni per operazioni multi-tabella**
3. **Gestire errori in modo consistente**
4. **Revalidare cache appropriatamente**
5. **Mantenere funzioni pure e testabili**
6. **Documentare business logic complessa**
7. **Usare TypeScript strict per type safety**

## ğŸ”— Collegamenti Importanti

- Schema Database: `prisma/schema.prisma`
- Definizioni Tipi: `app/lib/definitions.ts`
- Schemi Validazione: `app/lib/actions/entity-zod-schemas.ts`
- Test Actions: `test/actions.test.ts`
- Utility Helper: `app/lib/actions/utils/helpers.ts`
description:
globs:
alwaysApply: true
---
